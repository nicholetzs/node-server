# üå§Ô∏è Weather Forecast Dashboard with MongoDB + Express API

Este projeto √© um **dashboard meteorol√≥gico** que consome dados reais de uma API constru√≠da com **Node.js + Express** e um banco de dados **MongoDB**. A interface √© feita em **React + Tailwind CSS (via CDN)**.

O frontend (React) e o backend (Node.js + Express) est√£o hospedados separadamente:

- O **frontend** est√° hospedado no **Netlify**
- Reposit√≥rio: https://github.com/nicholetzs/node-server-client
- Site: https://forecasttemperatur.netlify.app/

Clique em atualizar previs√µes para buscar os dados do MongoDb! ‚òÑÔ∏è

- O **backend** est√° hospedado no **Render**

Eles se comunicam por meio de **requisi√ß√µes HTTP (`fetch`)**, configurando o `proxy` para aceitar chamadas da URL do backend hospedado.

---

## üöÄ Como come√ßar

Este projeto foi criado com [Create React App](https://github.com/facebook/create-react-app).

### üì¶ Pr√©-requisitos

- Node.js (v16+ recomendado)
- MongoDB Atlas ou local
- Conta no [Render](https://render.com/) (para o backend)
- Conta no [Netlify](https://www.netlify.com/) (para o frontend)

---

## üß≠ Estrutura do projeto

- **Backend**: API REST em Node.js que l√™ e salva previs√µes no MongoDB
- **Frontend**: Interface React com Tailwind (CDN), consumindo os dados da API hospedada no Render

---

## üõ†Ô∏è Scripts dispon√≠veis (frontend)

Na pasta do projeto frontend, voc√™ pode rodar:

### `npm start`

Roda o app em modo de desenvolvimento.\
Abra [http://localhost:3000](http://localhost:3000) para visualizar no navegador.

### `npm test`

Roda os testes interativos. Veja mais em [running tests](https://facebook.github.io/create-react-app/docs/running-tests).

### `npm run build`

Cria a vers√£o de produ√ß√£o na pasta `build`.

---

## üß™ Backend - Estrutura da API com Express + MongoDB

### üìÅ Arquivos principais:

#### `db.js` - Conex√£o com MongoDB

```js
// db.js - Configura√ß√£o da conex√£o com o MongoDB
import { MongoClient, ServerApiVersion } from "mongodb";
import dotenv from "dotenv";

dotenv.config();

const uri = process.env.MONGO_URI;
const nameDb = process.env.DB;

const client = new MongoClient(uri, {
  serverApi: {
    version: ServerApiVersion.v1,
    strict: true,
    deprecationErrors: true,
  },
});

export async function connectDB() {
  try {
    await client.connect();
    console.log("üî• Conectado ao MongoDB!");
    return client.db(nameDb);
  } catch (error) {
    console.error("Erro ao conectar ao MongoDB:", error);
    process.exit(1);
  }
}

export { client };
```

#### `index.js` - Servidor principal

```js
import { connectDB } from "./db.js";
import express from "express";
import { getWeatherData } from "./weather.js";
import dotenv from "dotenv";
import { saveWeatherData } from "./weatherSave.js";
import cors from "cors";
import { weatherLimiter } from "./weatherLimit.js"; // Importa o limitador de requisi√ß√µes

dotenv.config(); // Carrega as vari√°veis de ambiente do arquivo .env

const port = process.env.PORT; // Render define a porta automaticamente

async function startServer() {
  const db = await connectDB(); // Conecta ao MongoDB antes de iniciar o servidor
  const app = express();

  const allowedOrigins = [
    "http://localhost:3000", // Usei para desenvolvimento local com react
    "https://whitenights.onrender.com", // Para desenvolvimento local e acessar as rotas
    "https://forecasttemperatur.netlify.app", // Para acessar as rotas do Netlify
  ];

  app.use(
    cors({
      origin: allowedOrigins,
      methods: ["GET", "POST"],
      allowedHeaders: ["Content-Type", "Authorization"],
    })
  );

  if (!db) {
    console.error(
      "Erro ao conectar ao MongoDB. O servidor n√£o pode ser iniciado."
    );
    return;
  }

  // Rota para mostrar a resposta da API (teste)
  app.get("/weather", async (req, res) => {
    try {
      const weatherData = await getWeatherData(); // Chama a fun√ß√£o para obter os dados
      res.json(weatherData); // Retorna os dados da API para o cliente
      console.log(weatherData, "Dados da API"); // Log dos dados recebidos
    } catch (error) {
      res.status(500).send("Erro ao obter dados meteorol√≥gicos");
    }
  });

  // Rota para salvar os dados no MongoDB pegando da API
  app.post("/weatherSave", async (req, res) => {
    const token = req.headers["authorization"]; // Obt√©m o token do cabe√ßalho da requisi√ß√£o
    const secretToken = process.env.SECRET_TOKEN;

    if (token !== `Bearer ${secretToken}`) {
      console.error("Token inv√°lido, n√£o autorizado.");
      return res.status(403).json({ error: "Acesso n√£o autorizado." });
    }
    try {
      const insertedResult = await saveWeatherData(); // Salva os dados no MongoDB

      if (insertedResult && insertedResult.insertedCount > 0) {
        res.status(201).json({
          message: "‚úÖ Dados meteorol√≥gicos salvos com sucesso!",
          insertedCount: insertedResult.insertedCount,
        });
      } else {
        res.status(500).json({
          message:
            "‚ö† Nenhum dado foi salvo. Verifique a API ou a conex√£o com o banco.",
        });
      }
    } catch (error) {
      console.error("Erro ao salvar dados meteorol√≥gicos:", error);
      res.status(500).json({ error: "Erro ao salvar dados meteorol√≥gicos." });
    }
  });

  app.get("/weatherList", weatherLimiter, async (req, res) => {
    try {
      const db = await connectDB();
      const collection = db.collection("collection-weather");

      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0); // Zera a hora

      const dados = await collection
        .find({ timestamp: { $gte: hoje } })
        .sort({ timestamp: 1 })
        .toArray();

      res.status(200).json(dados);
    } catch (error) {
      console.error("Erro ao buscar dados do banco:", error);
      res.status(500).json({ error: "Erro ao buscar dados salvos." });
    }
  });

  app.get("/", async (req, res) => {
    res.status(200).send("Servidor est√° rodando e conectado ao MongoDB!");
  });

  app.listen(port, () => {
    console.log(`üöÄ Servidor rodando em http://localhost:${port}/`);
  });
}

startServer();
```

#### `weather.js` - Busca dados da API externa

```js
import dotenv from "dotenv";
dotenv.config();

export async function getWeatherData() {
  const weatherApiKey = process.env.WEATHER_API_KEY;
  const lat = -20.3155; // Latitude de Vit√≥ria
  const lon = -40.3128; // Longitude de Vit√≥ria

  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${weatherApiKey}&units=metric&lang=pt_br` // Essa API fornece previs√µes de 5 dias com dados a cada 3 horas.
    );

    if (!response.ok) {
      throw new Error("Erro na requisi√ß√£o para a API");
    }

    const data = await response.json();
    console.log(data, "Dados da API");

    return data; // Apenas retorna os dados, sem salvar no banco
  } catch (error) {
    console.error("Erro ao obter dados meteorol√≥gicos:", error);
    throw error;
  }
}
```

#### `weatherSave.js` - Salva previs√µes no banco

```js
import { connectDB } from "./db.js";
import { getWeatherData } from "./weather.js";

export async function saveWeatherData() {
  try {
    const data = await getWeatherData(); // Obt√©m os dados da API

    const db = await connectDB();
    const collection = db.collection("collection-weather"); // Define a cole√ß√£o

    const weatherData = data.list.map((forecast) => ({
      timestamp: new Date(forecast.dt * 1000),
      temperature: forecast.main.temp,
      temperature_min: forecast.main.temp_min, // Temperatura m√≠nima
      temperature_max: forecast.main.temp_max, // Temperatura m√°xima
      humidity: forecast.main.humidity,
      weather: forecast.weather[0].description,
      weather_icon: forecast.weather[0].icon,
      wind_speed: forecast.wind.speed,
      rain: forecast.rain ? true : false,
      location: "Vit√≥ria",
    }));

    const result = await collection.insertMany(weatherData);
    console.log("‚úÖ Dados meteorol√≥gicos salvos no MongoDB!");

    return result; // Retorna os dados inseridos
  } catch (error) {
    console.error("Erro ao salvar os dados no banco de dados:", error);
  }
}
```

#### `weatherLimit.js` - Limite de requisi√ß√£o para atualizar dados

```js
import rateLimit from "express-rate-limit";

export const weatherLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // Limite de 100 requisi√ß√µes por IP
  standardHeaders: true, // Envia headers padr√£o como RateLimit-*
  legacyHeaders: false, // Remove os headers `X-RateLimit-*` antigos
  message: "Muitas requisi√ß√µes desta m√°quina. Tente novamente mais tarde.",
});
```

---

## üé® Frontend - React + Tailwind via CDN

### Instala√ß√£o

```bash
npx create-react-app weather-dashboard
cd weather-dashboard
```

### Adicionar Tailwind CDN

No arquivo `public/index.html`, adicione dentro da `<head>`:

```html
<link
  href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
  rel="stylesheet"
/>
```

---

## üîÑ Integra√ß√£o com API

No componente `WeatherDashboards`:

```jsx
const [previsoes, setPrevisoes] = useState([]);

const buscarPrevisoes = async () => {
  setLoading(true);
  try {
    const resposta = await fetch(
      "https://whitenights.onrender.com/weatherList"
    );
    const dados = await resposta.json();
    setPrevisoes(dados);
  } catch (erro) {
    console.error("Erro ao buscar previs√µes:", erro);
  } finally {
    setLoading(false);
  }
};

<div className="flex items-center gap-4">
  <AtualizarPrevisoes onAtualizar={buscarPrevisoes} loading={loading} />
</div>;
```

A fun√ß√£o `buscarPrevisoes` busca os dados no MongoDb.

O frontend utiliza o **proxy** do `package.json` e configura√ß√µes CORS no backend para permitir essa comunica√ß√£o com dom√≠nios diferentes entre Netlify e Render.

---

## üß© Componentes

- `WeatherCard`: exibe uma previs√£o individual (dia, temperatura, condi√ß√£o)
- `AtualizarPrevisoes`: bot√£o para atualizar as previs√µes com a fun√ß√£o `buscarPrevisoes`

---

## üåê Deploy da API

A API est√° hospedada em:

```
https://whitenights.onrender.com/weatherSave
```

O frontend est√° hospedado em:

```
https://forecasttemperatur.netlify.app/
```

---

## üìö Aprenda mais

- [Documenta√ß√£o Create React App](https://facebook.github.io/create-react-app/docs/getting-started)
- [React](https://reactjs.org/)
- [Tailwind CSS](https://tailwindcss.com/docs/installation/play-cdn)
- [MongoDB Atlas](https://www.mongodb.com/atlas/database)
- [Render Deploy](https://render.com/docs/deploy-node-express-app)
- [Netlify Deploy](https://docs.netlify.com/)

---

Feito com ‚òï e curiosidade por **Nichole** ü™ê

üßä E agora sobre temp m√≠nima e m√°xima:
A OpenWeather API retorna dados de previs√£o a cada 3 horas, ou seja:

00h ‚Üí 23.5¬∞C

03h ‚Üí 21.7¬∞C

06h ‚Üí 20.1¬∞C

...

21h ‚Üí 24.8¬∞C

Se voc√™ agrupar todos os dados do mesmo dia, consegue descobrir:

üî∫Temp m√°xima do dia: 24.8¬∞C

üîªTemp m√≠nima do dia: 20.1¬∞C
